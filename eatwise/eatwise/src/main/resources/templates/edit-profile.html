<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EatWise - ì •ë³´ ìˆ˜ì •</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        .form-container {
            max-width: 600px;
            margin: 2rem auto;
            background: rgba(255,255,255,0.96);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(46, 125, 50, 0.08);
        }

        .form-container h2 {
            color: #2E7D32;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #d4f2c2;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2E7D32;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-update {
            flex: 1;
            background: linear-gradient(135deg, #66bb6a 0%, #2e7d32 100%);
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: transform 0.3s;
        }

        .btn-update:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        .btn-cancel {
            flex: 1;
            background: #f0f0f0;
            color: #666;
            border: 2px solid #d4f2c2;
            padding: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
            border-color: #2E7D32;
        }

        .info-text {
            background: #f7fbf1;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            color: #666;
            border-left: 4px solid #2E7D32;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 0.8rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .success-message {
            background: #f1f8e9;
            color: #33691e;
            padding: 0.8rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .form-container {
                padding: 1.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">EatWise</h1>
            <div class="nav-menu">
                <a href="/dashboard" class="nav-item">ëŒ€ì‹œë³´ë“œ</a>
                <a href="/restaurant-map" class="nav-item">ìŒì‹ì  ì§€ë„</a>
                <a href="/report" class="nav-item">ë ˆí¬íŠ¸</a>
                <a href="/edit-profile" class="nav-item active">ì •ë³´ ìˆ˜ì •</a>
                <button class="btn-notification" onclick="openNotifications()">
                    ğŸ”” ì•Œë¦¼
                    <span class="notification-badge" id="notificationBadge">0</span>
                </button>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="form-container">
            <h2>ê°œì¸ ì •ë³´ ìˆ˜ì •</h2>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <div class="info-text">
                â„¹ï¸ ë¹„ë°€ë²ˆí˜¸, ë‚˜ì´, í‚¤, ëª¸ë¬´ê²Œë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>

            <form id="updateForm" onsubmit="handleUpdateUser(event)">
                <div class="form-group">
                    <label for="password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ì„ íƒì‚¬í•­)</label>
                    <input type="password" id="password" name="password" placeholder="ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”">
                </div>

                <div class="form-group">
                    <label for="age">ë‚˜ì´</label>
                    <input type="number" id="age" name="age" min="1" max="120" placeholder="ë‚˜ì´ ì…ë ¥" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="height">í‚¤ (cm)</label>
                        <input type="number" id="height" name="height" min="100" max="250" step="0.1" placeholder="í‚¤ ì…ë ¥" required>
                    </div>

                    <div class="form-group">
                        <label for="weight">ëª¸ë¬´ê²Œ (kg)</label>
                        <input type="number" id="weight" name="weight" min="30" max="300" step="0.1" placeholder="ëª¸ë¬´ê²Œ ì…ë ¥" required>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-update">ì €ì¥</button>
                    <button type="button" class="btn-cancel" onclick="goBack()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let userInfo = null;

        window.onload = function() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/';
                return;
            }

            try {
                userInfo = JSON.parse(userStr);
                loadUserInfo(userInfo.userId || userInfo.id);
            } catch (e) {
                console.error('ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì‹¤íŒ¨:', e);
                window.location.href = '/';
            }
        };

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadUserInfo(userId) {
            try {
                const response = await fetch(`/api/users/${userId}`);

                if (response.ok) {
                    const user = await response.json();
                    console.log('âœ… ì‚¬ìš©ì ì •ë³´ ë¡œë“œ:', user);

                    // í¼ì— ì •ë³´ ì±„ìš°ê¸°
                    document.getElementById('age').value = user.age || '';
                    document.getElementById('height').value = user.height || '';
                    document.getElementById('weight').value = user.weight || '';
                } else {
                    console.error('âŒ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', response.status);
                    showError('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì •ë³´ ìˆ˜ì •
        async function handleUpdateUser(event) {
            event.preventDefault();

            const password = document.getElementById('password').value.trim();
            const age = parseInt(document.getElementById('age').value);
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!age || age < 1 || age > 120) {
                showError('ë‚˜ì´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!height || height < 100 || height > 250) {
                showError('í‚¤ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (100~250cm)');
                return;
            }
            if (!weight || weight < 30 || weight > 300) {
                showError('ëª¸ë¬´ê²Œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (30~300kg)');
                return;
            }

            try {
                const response = await fetch(`/api/users/${userInfo.userId || userInfo.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: password || null,
                        age: age,
                        height: height,
                        weight: weight
                    })
                });

                if (response.ok) {
                    const updatedUser = await response.json();
                    console.log('âœ… ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ì™„ë£Œ:', updatedUser);

                    // localStorage ì—…ë°ì´íŠ¸
                    localStorage.setItem('user', JSON.stringify(updatedUser));

                    showSuccess('ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');

                    // 3ì´ˆ í›„ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 2000);
                } else {
                    const error = await response.text();
                    console.error('âŒ ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨:', response.status, error);
                    showError('ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜:', error);
                showError('ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = 'âš ï¸ ' + message;
            errorDiv.style.display = 'block';

            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = 'âœ… ' + message;
            successDiv.style.display = 'block';
        }

        // ë’¤ë¡œ ê°€ê¸°
        function goBack() {
            window.location.href = '/dashboard';
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('user');
                window.location.href = '/';
            }
        }

        // ì•Œë¦¼ ëª¨ë‹¬ ì—´ê¸°
        function openNotifications() {
            // ì•Œë¦¼ ëª¨ë‹¬ì´ ì—†ìœ¼ë©´ ì„ì‹œë¡œ alert í‘œì‹œ
            alert('ì•Œë¦¼ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }

        // ì•Œë¦¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸ (í…ŒìŠ¤íŠ¸ìš©)
        function updateNotificationBadge() {
            const unreadCount = 0;
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                badge.textContent = unreadCount;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            updateNotificationBadge();
        });
    </script>
</body>
</html>

