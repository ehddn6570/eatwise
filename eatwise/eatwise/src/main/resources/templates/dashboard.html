<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EatWise - ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">EatWise</h1>
            <div class="nav-menu">
                <a href="/dashboard" class="nav-item active">ëŒ€ì‹œë³´ë“œ</a>
                <a href="/restaurant-map" class="nav-item">ìŒì‹ì  ì§€ë„</a>
                <a href="/report" class="nav-item">ë ˆí¬íŠ¸</a>
                <a href="/edit-profile" class="nav-item">ì •ë³´ ìˆ˜ì •</a>
                <button class="btn-notification" onclick="openNotifications()">
                    ğŸ”” ì•Œë¦¼
                    <span class="notification-badge" id="notificationBadge">0</span>
                </button>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="welcome-section">
            <h2>ì•ˆë…•í•˜ì„¸ìš”, <span id="username">ì‚¬ìš©ì</span>ë‹˜!</h2>
            <p>ê±´ê°•í•œ ì‹ìŠµê´€ì„ ìœ„í•œ ì—¬ì •ì„ ì‹œì‘í•´ë³´ì„¸ìš”</p>
        </div>

        <div class="dashboard-grid">
            <!-- ë‹¬ë ¥ -->
            <div class="card calendar-card">
                <div class="card-header">
                    <h3>ì‹ì‚¬ ê¸°ë¡ ë‹¬ë ¥</h3>
                </div>
                <div class="card-body">
                    <div class="calendar-container">
                        <div class="calendar-navigation">
                            <button class="btn-prev" onclick="previousMonth()">â—€</button>
                            <h4 id="currentMonth">2025ë…„ 11ì›”</h4>
                            <button class="btn-next" onclick="nextMonth()">â–¶</button>
                        </div>
                        <div class="calendar">
                            <div class="calendar-weekdays">
                                <div class="weekday">ì¼</div>
                                <div class="weekday">ì›”</div>
                                <div class="weekday">í™”</div>
                                <div class="weekday">ìˆ˜</div>
                                <div class="weekday">ëª©</div>
                                <div class="weekday">ê¸ˆ</div>
                                <div class="weekday">í† </div>
                            </div>
                            <div class="calendar-days" id="calendarDays"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ëŠ˜ì˜ ì¹¼ë¡œë¦¬ -->
            <div class="card">
                <div class="card-header">
                    <h3>ì˜¤ëŠ˜ì˜ ì¹¼ë¡œë¦¬</h3>
                    <button class="btn-goal-setting" onclick="openGoalModal()">âš™ï¸ ëª©í‘œì„¤ì •</button>
                </div>
                <div class="card-body">
                    <div class="calorie-info">
                        <div class="calorie-circle">
                            <span class="calorie-number" id="todayCalories">0</span>
                            <span class="calorie-unit">kcal</span>
                        </div>
                        <div class="calorie-detail">
                            <p>ëª©í‘œ: <strong id="calorieGoal">2000</strong> kcal</p>
                            <p>ë‚¨ì€ ì¹¼ë¡œë¦¬: <strong id="remainCalories">2000</strong> kcal</p>
                            <p>ì–´ì œ ì„­ì·¨ ì¹¼ë¡œë¦¬: <strong id="yesterdayCalories">0</strong> kcal</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì˜ì–‘ì†Œ ì„­ì·¨ -->
            <div class="card">
                <div class="card-header">
                    <h3>ì˜ì–‘ì†Œ ì„­ì·¨</h3>
                    <button class="btn-add" onclick="addMeal()">+ ì‹ì‚¬ ì¶”ê°€</button>
                </div>
                <div class="card-body">
                    <div class="nutrient-item">
                        <span>íƒ„ìˆ˜í™”ë¬¼</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="carbsProgress" style="width: 0%"></div>
                        </div>
                        <span><span id="carbsAmount">0</span>g / <span id="carbsGoal">300</span>g</span>
                    </div>
                    <div class="nutrient-item">
                        <span>ë‹¨ë°±ì§ˆ</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="proteinProgress" style="width: 0%"></div>
                        </div>
                        <span><span id="proteinAmount">0</span>g / <span id="proteinGoal">100</span>g</span>
                    </div>
                    <div class="nutrient-item">
                        <span>ì§€ë°©</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="fatProgress" style="width: 0%"></div>
                        </div>
                        <span><span id="fatAmount">0</span>g / <span id="fatGoal">65</span>g</span>
                    </div>
                </div>
            </div>

            <!-- ìµœê·¼ ì‹ì‚¬ ê¸°ë¡ ì¹´ë“œ ì œê±°ë¨ -->

        </div>
    </div>

    <!-- ëª©í‘œì„¤ì • ëª¨ë‹¬ -->
    <div id="goalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ëª©í‘œ ì„¤ì •</h2>
                <span class="close" onclick="closeGoalModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: #666;">ë‹¹ì‹ ì˜ ëª©í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                <div class="goal-options">
                    <button class="goal-btn" onclick="selectGoal('GAIN')">
                        <div class="goal-icon">â¬†ï¸</div>
                        <div class="goal-name">ì²´ì¤‘ ì¦ëŸ‰</div>
                        <div class="goal-desc">+300 kcal</div>
                    </button>
                    <button class="goal-btn" onclick="selectGoal('MAINTAIN')">
                        <div class="goal-icon">â¡ï¸</div>
                        <div class="goal-name">ì²´ì¤‘ ìœ ì§€</div>
                        <div class="goal-desc">ê¸°ë³¸ ì¹¼ë¡œë¦¬</div>
                    </button>
                    <button class="goal-btn" onclick="selectGoal('LOSE')">
                        <div class="goal-icon">â¬‡ï¸</div>
                        <div class="goal-name">ì²´ì¤‘ ê°ëŸ‰</div>
                        <div class="goal-desc">-300 kcal</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ ëª¨ë‹¬ -->
    <div id="notificationModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ì•Œë¦¼</h2>
                <span class="close" onclick="closeNotifications()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="notificationList" style="max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; color: #999; padding: 2rem;">
                        <p>ğŸ“¬ ì½ì§€ì•Šì€ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë‚ ì§œë³„ ì‹ì‚¬ ê¸°ë¡ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="mealEditModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="mealEditTitle">2025ë…„ 11ì›” 20ì¼ ì‹ì‚¬ ê¸°ë¡</h2>
                <span class="close" onclick="closeMealEditModal()">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 500px; overflow-y: auto; overflow-x: hidden;">
                <div id="mealEditContent">
                    <p>ë¡œë”© ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‹ì‚¬ ê¸°ë¡ ìƒì„¸ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="mealDetailEditModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ì‹ì‚¬ ê¸°ë¡ ìˆ˜ì •</h2>
                <span class="close" onclick="closeMealDetailEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="mealDetailEditForm">
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">ìŒì‹ëª…</label>
                        <input type="text" id="editFoodName" readonly style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
                    </div>

                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">ì‹ì‚¬ ìœ í˜•</label>
                        <select id="editMealType" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="BREAKFAST">ğŸŒ… ì•„ì¹¨</option>
                            <option value="LUNCH">â˜€ï¸ ì ì‹¬</option>
                            <option value="DINNER">ğŸŒ™ ì €ë…</option>
                            <option value="SNACK">ğŸª ê°„ì‹</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">ì„­ì·¨ ì‹œê°„</label>
                        <input type="time" id="editIntakeTime" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">ìˆ˜ëŸ‰ (g)</label>
                        <input type="number" id="editQuantity" min="0.1" step="0.1" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>

                    <div class="form-buttons" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" style="flex: 1; background: linear-gradient(135deg, #66bb6a 0%, #2e7d32 100%); color: white; border: none; padding: 0.8rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ì €ì¥
                        </button>
                        <button type="button" onclick="closeMealDetailEditModal()" style="flex: 1; background: #e0e0e0; color: #333; border: none; padding: 0.8rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let mealRecords = {};  // ë‚ ì§œë³„ ì‹ì‚¬ ê¸°ë¡ ì €ì¥
        let todayMeals = [];   // ì˜¤ëŠ˜ì˜ ì‹ì‚¬ ê¸°ë¡
        let userInfo = null;   // ì‚¬ìš©ì ì •ë³´
        let dailyGoals = {     // ì¼ì¼ ëª©í‘œ
            calories: 2000,
            carbs: 300,
            protein: 100,
            fat: 65
        };

        // í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€ ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´ ë°˜í™˜ (YYYY-MM-DD)
        function getTodayDateString() {
            const now = new Date();
            const kstDate = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
            return kstDate.toISOString().split('T')[0];
        }

        // ë§ˆì§€ë§‰ìœ¼ë¡œ ë¡œë“œí•œ ë‚ ì§œ ì´ˆê¸°í™”
        let lastLoadedDate = getTodayDateString();

        // ìŒì‹ ì¹´í…Œê³ ë¦¬ë¥¼ í•œê¸€ë¡œ ë³€í™˜
        function getCategoryInKorean(category) {
            const categoryMap = {
                'korean': 'í•œì‹',
                'western': 'ì–‘ì‹',
                'japanese': 'ì¼ì‹',
                'chinese': 'ì¤‘ì‹',
                'beverage': 'ìŒë£Œ',
                'í•œì‹': 'í•œì‹',
                'ì–‘ì‹': 'ì–‘ì‹',
                'ì¼ì‹': 'ì¼ì‹',
                'ì¤‘ì‹': 'ì¤‘ì‹',
                'ìŒë£Œ': 'ìŒë£Œ'
            };
            return categoryMap[category] || category || 'ê¸°íƒ€';
        }

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        window.onload = async function() {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    userInfo = JSON.parse(userStr);
                    document.getElementById('username').textContent = userInfo.username || 'ì‚¬ìš©ì';

                    // ì‚¬ìš©ì ì •ë³´ ê¸°ë°˜ ì¹¼ë¡œë¦¬ ëª©í‘œ ê³„ì‚°
                    calculateDailyGoals(userInfo);

                    // ë‹¬ë ¥ ì´ˆê¸°í™” ë° ì‹ì‚¬ ê¸°ë¡ ë¡œë“œ
                    await loadMealRecords(userInfo.userId || userInfo.id);
                    renderCalendar();
                    await loadTodayNutrients(userInfo.userId || userInfo.id);  // ì˜¤ëŠ˜ì˜ ì˜ì–‘ì†Œ ì •ë³´
                    await loadYesterdayCalories(userInfo.userId || userInfo.id);  // ì–´ì œ ì¹¼ë¡œë¦¬ ì¡°íšŒ
                    // ìµœê·¼ ì‹ì‚¬ ê¸°ë¡ì€ ìµœê·¼ ì‹ì‚¬ ê¸°ë¡ ì¹´ë“œê°€ ì œê±°ë˜ì–´ í•¨ìˆ˜ í˜¸ì¶œ ì œê±°
                } catch (e) {
                    console.error('ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì‹¤íŒ¨:', e);
                }
            }

            // ì‹ì‚¬ ê¸°ë¡ ìˆ˜ì • í¼ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupMealDetailEditFormListener();

            // ìì •(00:00)ì— ì¹¼ë¡œë¦¬ ì´ˆê¸°í™”í•˜ë„ë¡ ì„¤ì •
            scheduleNextMidnight();
        };

        // ë‹¤ìŒ ìì •ê¹Œì§€ì˜ ì‹œê°„(ë°€ë¦¬ì´ˆ) ê³„ì‚° (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
        function getTimeUntilNextMidnight() {
            const now = new Date();
            const kstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9

            // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë‚´ì¼ ìì • ê³„ì‚°
            const tomorrow = new Date(kstNow);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);

            // UTC ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í˜„ì¬ ì‹œê°„ê³¼ ë¹„êµ
            const tomorrowUtc = new Date(tomorrow.getTime() - (9 * 60 * 60 * 1000));
            const timeUntil = tomorrowUtc - now;

            console.log(`â° í˜„ì¬ KST: ${kstNow.toLocaleString('ko-KR')}`);
            console.log(`â° ë‹¤ìŒ ìì • KST: ${tomorrow.toLocaleString('ko-KR')}`);
            console.log(`â° ë‹¤ìŒ ìì •ê¹Œì§€ ë‚¨ì€ ì‹œê°„: ${Math.floor(timeUntil / 1000)}ì´ˆ`);
            return timeUntil;
        }

        // ìì •ì— ì¹¼ë¡œë¦¬ ì´ˆê¸°í™” ìŠ¤ì¼€ì¤„ë§
        function scheduleNextMidnight() {
            const timeUntilMidnight = getTimeUntilNextMidnight();

            setTimeout(() => {
                console.log('ğŸŒ™ ìì •ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹¼ë¡œë¦¬ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.');
                lastLoadedDate = getTodayDateString();

                if (userInfo) {
                    // ì˜¤ëŠ˜ì˜ ì˜ì–‘ì†Œ ì •ë³´ ìƒˆë¡œê³ ì¹¨ (ì¹¼ë¡œë¦¬ 0ìœ¼ë¡œ ì´ˆê¸°í™”)
                    loadTodayNutrients(userInfo.userId || userInfo.id);
                    // ë‹¬ë ¥ ìƒˆë¡œê³ ì¹¨
                    loadMealRecords(userInfo.userId || userInfo.id).then(() => renderCalendar());
                }

                // ë‹¤ìŒ ìì •ì„ ìœ„í•´ ë‹¤ì‹œ ìŠ¤ì¼€ì¤„ë§
                scheduleNextMidnight();
            }, timeUntilMidnight);
        }

        // ì‚¬ìš©ì ì •ë³´ ê¸°ë°˜ ì¼ì¼ ì¹¼ë¡œë¦¬ ëª©í‘œ ê³„ì‚° (Harris-Benedict ê³µì‹)
        function calculateDailyGoals(user) {
            let bmr = 0;

            if (user.gender === 'M' || user.gender === 'male') {
                // ë‚¨ì„±: 88.362 + (13.397 Ã— ì²´ì¤‘) + (4.799 Ã— í‚¤) - (5.677 Ã— ë‚˜ì´)
                bmr = 88.362 + (13.397 * user.weight) + (4.799 * user.height) - (5.677 * (user.age || 30));
            } else {
                // ì—¬ì„±: 447.593 + (9.247 Ã— ì²´ì¤‘) + (3.098 Ã— í‚¤) - (4.330 Ã— ë‚˜ì´)
                bmr = 447.593 + (9.247 * user.weight) + (3.098 * user.height) - (4.330 * (user.age || 30));
            }

            // í™œë™ëŸ‰ ê³„ìˆ˜ 1.5 (ë³´í†µ í™œë™)
            const tdee = Math.round(bmr * 1.5);

            // ì¼ì¼ ëª©í‘œ ì„¤ì •
            dailyGoals.calories = tdee;
            dailyGoals.carbs = Math.round(tdee * 0.5 / 4);    // 50% carbs, 1g = 4kcal
            dailyGoals.protein = Math.round(tdee * 0.25 / 4);  // 25% protein
            dailyGoals.fat = Math.round(tdee * 0.25 / 9);      // 25% fat, 1g = 9kcal

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('calorieGoal').textContent = dailyGoals.calories;
            document.getElementById('carbsGoal').textContent = dailyGoals.carbs;
            document.getElementById('proteinGoal').textContent = dailyGoals.protein;
            document.getElementById('fatGoal').textContent = dailyGoals.fat;

            console.log('ğŸ“Š ì¼ì¼ ëª©í‘œ ì„¤ì •:', dailyGoals);
        }

        // ì˜¤ëŠ˜ì˜ ì‹ì‚¬ ê¸°ë¡ ì¡°íšŒ
        // ìµœê·¼ ì‹ì‚¬ ê¸°ë¡ ì¡°íšŒ (ìµœê·¼ 6ê°œ)
        async function loadRecentMeals(userId) {
            try {
                // ìµœê·¼ 30ì¼ê°„ì˜ ì‹ì‚¬ ê¸°ë¡ ì¡°íšŒ
                const endDate = new Date().toISOString().split('T')[0];
                const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                const response = await fetch(`/api/meal-records/user/${userId}/date-range?startDate=${startDate}&endDate=${endDate}`);

                if (response.ok) {
                    const allRecords = await response.json();
                    // ìµœì‹  ê¸°ë¡ ìˆœì„œë¡œ ì •ë ¬
                    todayMeals = allRecords.sort((a, b) => {
                        const dateTimeA = new Date(`${a.intakeDate}T${a.intakeTime}`);
                        const dateTimeB = new Date(`${b.intakeDate}T${b.intakeTime}`);
                        return dateTimeB - dateTimeA;
                    }).slice(0, 6);  // ìµœê·¼ 6ê°œë§Œ ì„ íƒ
                    console.log('ğŸ“… ìµœê·¼ ì‹ì‚¬ ê¸°ë¡:', todayMeals);
                    updateRecentMeals();
                }
            } catch (error) {
                console.error('ìµœê·¼ ì‹ì‚¬ ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ì˜¤ëŠ˜ì˜ ì¹¼ë¡œë¦¬ì™€ ì˜ì–‘ì†Œ ì¡°íšŒ
        async function loadTodayNutrients(userId) {
            try {
                const today = getTodayDateString();
                console.log('ğŸ“… ì˜¤ëŠ˜ ë‚ ì§œ (í•œêµ­ì‹œê°„):', today);
                const response = await fetch(`/api/meal-records/user/${userId}/date/${today}`);

                if (response.ok) {
                    const todayRecords = await response.json();
                    console.log('ğŸ“… ì˜¤ëŠ˜ì˜ ì‹ì‚¬ ê¸°ë¡ (ì˜ì–‘ì†Œ):', todayRecords);
                    updateNutrientInfo(todayRecords);
                }
            } catch (error) {
                console.error('ì˜¤ëŠ˜ì˜ ì˜ì–‘ì†Œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ì–´ì œ ì¹¼ë¡œë¦¬ ì¡°íšŒ
        async function loadYesterdayCalories(userId) {
            try {
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                // ì–´ì œ ë‚ ì§œë¥¼ í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
                const kstYesterday = new Date(yesterday.getTime() + (9 * 60 * 60 * 1000));
                const yesterdayDate = kstYesterday.toISOString().split('T')[0];

                console.log('ğŸ“… ì–´ì œ ë‚ ì§œ (í•œêµ­ì‹œê°„):', yesterdayDate);
                const response = await fetch(`/api/meal-records/user/${userId}/date/${yesterdayDate}`);

                if (response.ok) {
                    const yesterdayRecords = await response.json();
                    console.log('ğŸ“… ì–´ì œì˜ ì‹ì‚¬ ê¸°ë¡:', yesterdayRecords);

                    // ì–´ì œ ì´ ì¹¼ë¡œë¦¬ ê³„ì‚°
                    let yesterdayCalories = 0;
                    yesterdayRecords.forEach(meal => {
                        yesterdayCalories += meal.totalCalories || 0;
                    });

                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('yesterdayCalories').textContent = Math.round(yesterdayCalories);
                }
            } catch (error) {
                console.error('ì–´ì œ ì¹¼ë¡œë¦¬ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }

        // ì˜ì–‘ì†Œ ì •ë³´ ì—…ë°ì´íŠ¸ (ì˜¤ëŠ˜ ê¸°ë¡ë§Œ)
        function updateNutrientInfo(todayRecords) {
            let totalCalories = 0;
            let totalCarbs = 0;
            let totalProtein = 0;
            let totalFat = 0;

            console.log('ğŸ“Š ì˜ì–‘ì†Œ ê³„ì‚° ì‹œì‘:', todayRecords);

            todayRecords.forEach(meal => {
                totalCalories += meal.totalCalories || 0;
                // ìŒì‹ì˜ ì‹¤ì œ ì˜ì–‘ì†Œ ì •ë³´ ì‚¬ìš©
                if (meal.food) {
                    const quantity = (meal.quantity || 1) / 100; // ê·¸ë¨ì„ ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜
                    const carbsAdd = (meal.food.carbs || 0) * quantity;
                    const proteinAdd = (meal.food.protein || 0) * quantity;
                    const fatAdd = (meal.food.fat || 0) * quantity;

                    console.log(`ğŸ“ ${meal.food.foodName}: carbs=${carbsAdd}, protein=${proteinAdd}, fat=${fatAdd}`);

                    totalCarbs += carbsAdd;
                    totalProtein += proteinAdd;
                    totalFat += fatAdd;
                } else {
                    console.log('âš ï¸ food ì •ë³´ ì—†ìŒ:', meal);
                }
            });

            console.log(`âœ… ì´ ì˜ì–‘ì†Œ: carbs=${Math.round(totalCarbs)}, protein=${Math.round(totalProtein)}, fat=${Math.round(totalFat)}`);

            // ì¹¼ë¡œë¦¬ ì •ë³´ ì—…ë°ì´íŠ¸
            const remainCalories = dailyGoals.calories - totalCalories;
            document.getElementById('todayCalories').textContent = Math.round(totalCalories);
            document.getElementById('remainCalories').textContent = Math.max(0, Math.round(remainCalories));

            // ì˜ì–‘ì†Œ ì •ë³´ ì—…ë°ì´íŠ¸
            const carbsPercent = Math.min(100, (totalCarbs / dailyGoals.carbs) * 100);
            const proteinPercent = Math.min(100, (totalProtein / dailyGoals.protein) * 100);
            const fatPercent = Math.min(100, (totalFat / dailyGoals.fat) * 100);

            document.getElementById('carbsProgress').style.width = carbsPercent + '%';
            document.getElementById('proteinProgress').style.width = proteinPercent + '%';
            document.getElementById('fatProgress').style.width = fatPercent + '%';

            document.getElementById('carbsAmount').textContent = totalCarbs.toFixed(1);
            document.getElementById('proteinAmount').textContent = totalProtein.toFixed(1);
            document.getElementById('fatAmount').textContent = totalFat.toFixed(1);
        }

        // ìµœê·¼ ì‹ì‚¬ ê¸°ë¡ ì—…ë°ì´íŠ¸
        function updateRecentMeals() {
            const container = document.getElementById('recentMealsContainer');

            if (!todayMeals || todayMeals.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>ì•„ì§ ê¸°ë¡ëœ ì‹ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p><p>ì²« ì‹ì‚¬ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”!</p></div>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
            todayMeals.forEach((meal, index) => {
                const mealTypeLabel = {
                    'breakfast': 'ğŸŒ… ì•„ì¹¨',
                    'lunch': 'â˜€ï¸ ì ì‹¬',
                    'dinner': 'ğŸŒ™ ì €ë…',
                    'snack': 'ğŸª ê°„ì‹'
                };

                // ë‚ ì§œ, ì‹ì‚¬ ìœ í˜•, ì‹œê°„ í¬ë§·íŒ…
                let mealInfo = '';
                if (meal.intakeDate && meal.intakeTime) {
                    const timeParts = meal.intakeTime.split(':');
                    const time = `${timeParts[0]}:${timeParts[1]}`;
                    const mealTypeText = mealTypeLabel[meal.mealType] || meal.mealType;
                    mealInfo = `${meal.intakeDate} ${mealTypeText} ${time}`;
                } else if (meal.intakeDate) {
                    const mealTypeText = mealTypeLabel[meal.mealType] || meal.mealType;
                    mealInfo = `${meal.intakeDate} ${mealTypeText}`;
                }

                html += `
                    <div style="background: #f7fbf1; padding: 1rem; border-radius: 8px; border-left: 4px solid #2E7D32;">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>${meal.foodName}</strong>
                                <div style="color: #666; font-size: 0.9em; margin-top: 0.3rem;">${mealInfo}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: #2E7D32;">${Math.round(meal.totalCalories)} kcal</div>
                                <div style="color: #999; font-size: 0.85em;">${meal.quantity}g</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // ì‹ì‚¬ ê¸°ë¡ ì¡°íšŒ
        async function loadMealRecords(userId) {
            try {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                // ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì›”ì˜ ì²«ë‚ ê³¼ ë§ˆì§€ë§‰ë‚  ê³„ì‚°
                const startDate = new Date(year, month, 1);
                const endDate = new Date(year, month + 1, 0);

                // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const startDateStr = startDate.getFullYear() + '-' +
                                    String(startDate.getMonth() + 1).padStart(2, '0') + '-' +
                                    String(startDate.getDate()).padStart(2, '0');

                const endDateStr = endDate.getFullYear() + '-' +
                                  String(endDate.getMonth() + 1).padStart(2, '0') + '-' +
                                  String(endDate.getDate()).padStart(2, '0');

                console.log('ğŸ” ì¡°íšŒ ë²”ìœ„:', startDateStr, '~', endDateStr);
                console.log('ğŸ” userId:', userId);

                const response = await fetch(`/api/meal-records/user/${userId}/date-range?startDate=${startDateStr}&endDate=${endDateStr}`);

                console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status);

                if (response.ok) {
                    const records = await response.json();
                    console.log('âœ… API ì‘ë‹µ ë°ì´í„°:', records);

                    // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
                    mealRecords = {};
                    records.forEach(record => {
                        console.log('ğŸ“ ì‹ì‚¬ ê¸°ë¡ ì²˜ë¦¬:', record.intakeDate, record.foodName);
                        if (!mealRecords[record.intakeDate]) {
                            mealRecords[record.intakeDate] = [];
                        }
                        mealRecords[record.intakeDate].push(record);
                    });

                    console.log('ğŸ“… ê·¸ë£¹í™”ëœ ì‹ì‚¬ ê¸°ë¡:', Object.keys(mealRecords));
                } else {
                    console.error('âŒ API ì˜¤ë¥˜:', response.status);
                    mealRecords = {};
                }
            } catch (error) {
                console.error('âŒ ì‹ì‚¬ ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
                mealRecords = {};
            }
        }

        // ë‹¬ë ¥ ë Œë”ë§
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // ì›” í‘œì‹œ ì—…ë°ì´íŠ¸
            const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”',
                              '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
            document.getElementById('currentMonth').textContent = `${year}ë…„ ${monthNames[month]}`;

            // ì²« ë‚ ì˜ ìš”ì¼ê³¼ ë§ˆì§€ë§‰ ë‚ ì§œ
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            const calendarDaysDiv = document.getElementById('calendarDays');
            calendarDaysDiv.innerHTML = '';

            console.log(`ğŸ“… [ë‹¬ë ¥ ë Œë”ë§] ${year}ë…„ ${month + 1}ì›”`);
            console.log(`ğŸ“… [ë¡œë“œëœ ì‹ì‚¬ ê¸°ë¡ ë‚ ì§œë“¤]:`, Object.keys(mealRecords));

            // ë¹ˆ ì¹¸ ì¶”ê°€
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarDaysDiv.appendChild(emptyDay);
            }

            // ë‚ ì§œ ì¶”ê°€
            const today = new Date();
            const mealTypeIcons = {
                'breakfast': 'ğŸŒ…',
                'BREAKFAST': 'ğŸŒ…',
                'lunch': 'â˜€ï¸',
                'LUNCH': 'â˜€ï¸',
                'dinner': 'ğŸŒ™',
                'DINNER': 'ğŸŒ™',
                'snack': 'ğŸª',
                'SNACK': 'ğŸª'
            };
            const mealTypeLabels = {
                'breakfast': 'ì•„ì¹¨',
                'BREAKFAST': 'ì•„ì¹¨',
                'lunch': 'ì ì‹¬',
                'LUNCH': 'ì ì‹¬',
                'dinner': 'ì €ë…',
                'DINNER': 'ì €ë…',
                'snack': 'ê°„ì‹',
                'SNACK': 'ê°„ì‹'
            };

            for (let date = 1; date <= lastDate; date++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';

                // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë‚ ì§œ ìƒì„±
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;

                // ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡°
                if (year === today.getFullYear() &&
                    month === today.getMonth() &&
                    date === today.getDate()) {
                    dayDiv.classList.add('today');
                }

                // ì‹ì‚¬ ê¸°ë¡ì´ ìˆëŠ” ë‚ ì§œ í™•ì¸
                if (mealRecords[dateStr] && mealRecords[dateStr].length > 0) {
                    console.log(`âœ… [${dateStr}] ì‹ì‚¬ ê¸°ë¡ ë°œê²¬: ${mealRecords[dateStr].length}ê°œ`);
                    dayDiv.classList.add('has-record');

                    // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    dayDiv.style.cursor = 'pointer';
                    dayDiv.addEventListener('click', () => {
                        openMealEditModal(dateStr, mealRecords[dateStr]);
                    });

                    const dateLabel = document.createElement('div');
                    dateLabel.className = 'day-date';
                    dateLabel.textContent = date;
                    dayDiv.appendChild(dateLabel);

                    const foodInfo = document.createElement('div');
                    foodInfo.className = 'day-foods';

                    // ì‹ì‚¬ ìœ í˜•ê³¼ ìŒì‹ëª…ì„ í•¨ê»˜ í‘œì‹œ
                    const mealsByType = {};
                    mealRecords[dateStr].forEach(r => {
                        const type = (r.mealType || 'snack').toLowerCase();
                        if (!mealsByType[type]) {
                            mealsByType[type] = [];
                        }
                        mealsByType[type].push(r.foodName);
                    });

                    // ì‹ì‚¬ ìœ í˜•ë³„ë¡œ ì •ë ¬í•˜ì—¬ í‘œì‹œ
                    const foodTexts = [];
                    ['breakfast', 'lunch', 'dinner', 'snack'].forEach(type => {
                        if (mealsByType[type]) {
                            const icon = mealTypeIcons[type] || '';
                            const foods = mealsByType[type].join(', ');
                            foodTexts.push(`${icon} ${foods}`);
                        }
                    });

                    foodInfo.textContent = foodTexts.join('\n');
                    dayDiv.appendChild(foodInfo);

                    const calorieInfo = document.createElement('div');
                    calorieInfo.className = 'day-calories';
                    const totalCalories = mealRecords[dateStr].reduce((sum, r) => sum + (r.totalCalories || 0), 0);
                    calorieInfo.textContent = Math.round(totalCalories) + ' kcal';
                    dayDiv.appendChild(calorieInfo);
                } else {
                    // ë¹ˆ ë‚ ì§œ: ë‚ ì§œ ë²ˆí˜¸ë§Œ í‘œì‹œ
                    dayDiv.textContent = date;

                    // ë¹ˆ ë‚ ì§œë„ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ - ì‹ì‚¬ ì¶”ê°€
                    dayDiv.style.cursor = 'pointer';
                    dayDiv.addEventListener('click', () => {
                        openAddMealForDateModal(dateStr);
                    });
                }

                calendarDaysDiv.appendChild(dayDiv);
            }
        }

        // ì´ì „ ë‹¬
        async function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            await loadMealRecords(userInfo.userId || userInfo.id);
            renderCalendar();
        }

        // ë‹¤ìŒ ë‹¬
        async function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            await loadMealRecords(userInfo.userId || userInfo.id);
            renderCalendar();
        }

        // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('user');
                window.location.href = '/';
            }
        }

        // ì‹ì‚¬ ì¶”ê°€ ê¸°ëŠ¥
        function addMeal() {
            window.location.href = '/add-meal';
        }

        // ëª©í‘œì„¤ì • ëª¨ë‹¬ ì—´ê¸°
        function openGoalModal() {
            document.getElementById('goalModal').style.display = 'block';
        }

        // ëª©í‘œì„¤ì • ëª¨ë‹¬ ë‹«ê¸°
        function closeGoalModal() {
            document.getElementById('goalModal').style.display = 'none';
        }

        // ëª©í‘œ ì„ íƒ ë° ì €ì¥
        async function selectGoal(goalType) {
            try {
                const response = await fetch('/api/goals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userInfo.userId || userInfo.id,
                        goalType: goalType,
                        startDate: new Date().toISOString().split('T')[0],
                        endDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                    })
                });

                if (response.ok) {
                    const goal = await response.json();
                    console.log('âœ… ëª©í‘œ ì„¤ì • ì™„ë£Œ:', goal);

                    // ì¹¼ë¡œë¦¬ ëª©í‘œ ì—…ë°ì´íŠ¸
                    dailyGoals.calories = Math.round(goal.dailyCalorieTarget);
                    document.getElementById('calorieGoal').textContent = dailyGoals.calories;

                    // ì˜ì–‘ì†Œ ë¹„ìœ¨ì— ë”°ë¼ ëª©í‘œ ì¬ê³„ì‚°
                    const carbRatio = goal.carbRatio || 0.5;
                    const proteinRatio = goal.proteinRatio || 0.25;
                    const fatRatio = goal.fatRatio || 0.25;

                    // ê° ì˜ì–‘ì†Œì˜ ëª©í‘œ ê·¸ë¨ ìˆ˜ ê³„ì‚°
                    dailyGoals.carbs = Math.round(goal.dailyCalorieTarget * carbRatio / 4);      // 1g = 4 kcal
                    dailyGoals.protein = Math.round(goal.dailyCalorieTarget * proteinRatio / 4); // 1g = 4 kcal
                    dailyGoals.fat = Math.round(goal.dailyCalorieTarget * fatRatio / 9);         // 1g = 9 kcal

                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('carbsGoal').textContent = dailyGoals.carbs;
                    document.getElementById('proteinGoal').textContent = dailyGoals.protein;
                    document.getElementById('fatGoal').textContent = dailyGoals.fat;

                    // ì˜ì–‘ì†Œ ì •ë³´ ì¬ê³„ì‚°
                    updateNutrientInfo(todayMeals);

                    // ëª¨ë‹¬ ë‹«ê¸°
                    closeGoalModal();

                    alert('ëª©í‘œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¯');
                } else {
                    console.error('âŒ ëª©í‘œ ì„¤ì • ì‹¤íŒ¨:', response.status);
                    alert('ëª©í‘œ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ ëª©í‘œ ì„¤ì • ì¤‘ ì˜¤ë¥˜:', error);
                alert('ëª©í‘œ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const goalModal = document.getElementById('goalModal');
            const notificationModal = document.getElementById('notificationModal');
            const mealEditModal = document.getElementById('mealEditModal');
            const mealDetailEditModal = document.getElementById('mealDetailEditModal');

            if (event.target === goalModal) {
                closeGoalModal();
            }
            if (event.target === notificationModal) {
                closeNotifications();
            }
            if (event.target === mealEditModal) {
                closeMealEditModal();
            }
            if (event.target === mealDetailEditModal) {
                closeMealDetailEditModal();
            }
        }

        // ì•Œë¦¼ í•¨ìˆ˜ë“¤
        function openNotifications() {
            document.getElementById('notificationModal').style.display = 'block';
            // ì—¬ê¸°ì— ì•Œë¦¼ ëª©ë¡ ë¡œë“œ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
        }

        function closeNotifications() {
            document.getElementById('notificationModal').style.display = 'none';
        }

        // ì‹ì‚¬ ê¸°ë¡ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function openMealEditModal(dateStr, meals) {
            const modal = document.getElementById('mealEditModal');
            const title = document.getElementById('mealEditTitle');
            const content = document.getElementById('mealEditContent');

            // ì œëª© ì„¤ì •
            const date = new Date(dateStr + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'short'
            });
            title.textContent = `${formattedDate} ì‹ì‚¬ ê¸°ë¡`;

            // ì‹ì‚¬ ê¸°ë¡ í‘œì‹œ
            displayMealEditContent(content, dateStr, meals);

            // ëª¨ë‹¬ í‘œì‹œ
            modal.style.display = 'block';
        }

        // ì‹ì‚¬ ê¸°ë¡ ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
        function closeMealEditModal() {
            document.getElementById('mealEditModal').style.display = 'none';
        }

        // ì‹ì‚¬ ê¸°ë¡ ìƒì„¸ ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
        function closeMealDetailEditModal() {
            document.getElementById('mealDetailEditModal').style.display = 'none';
        }

        // í˜„ì¬ ìˆ˜ì • ì¤‘ì¸ ì‹ì‚¬ ê¸°ë¡ ID ì €ì¥
        let currentEditingMealRecordId = null;

        // ì‹ì‚¬ ê¸°ë¡ ë‚´ìš© í‘œì‹œ
        function displayMealEditContent(container, dateStr, meals) {
            const mealTypeEmoji = {
                'BREAKFAST': 'ğŸŒ…',
                'LUNCH': 'â˜€ï¸',
                'DINNER': 'ğŸŒ™',
                'SNACK': 'ğŸª'
            };

            const mealTypeLabels = {
                'BREAKFAST': 'ì•„ì¹¨',
                'LUNCH': 'ì ì‹¬',
                'DINNER': 'ì €ë…',
                'SNACK': 'ê°„ì‹'
            };

            // ì‹ì‚¬ë¥¼ ìœ í˜•ë³„ë¡œ ê·¸ë£¹í™”
            const groupedMeals = {};
            meals.forEach(meal => {
                const type = (meal.mealType || 'SNACK').toUpperCase();
                const key = `${type}_${meal.intakeTime}`;
                if (!groupedMeals[key]) {
                    groupedMeals[key] = {
                        recordId: meal.recordId,
                        mealType: type,
                        intakeTime: meal.intakeTime,
                        foods: []
                    };
                }
                groupedMeals[key].foods.push(meal);
            });

            // HTML ìƒì„±
            let html = '<div style="display: flex; flex-direction: column; gap: 1rem; box-sizing: border-box; width: 100%;">';

            Object.values(groupedMeals).forEach(mealGroup => {
                const emoji = mealTypeEmoji[mealGroup.mealType] || 'ğŸ½ï¸';
                const label = mealTypeLabels[mealGroup.mealType] || 'ì‹ì‚¬';

                html += `
                    <div style="background: #f7fbf1; padding: 1rem; border-radius: 8px; border-left: 4px solid #2E7D32; box-sizing: border-box; width: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="font-weight: 600; color: #333;">
                                ${emoji} ${label} (${mealGroup.intakeTime})
                            </div>
                            <button class="btn-delete" onclick="deleteMealRecord(${mealGroup.recordId}, '${dateStr}')" style="background: #ff5252; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem; flex-shrink: 0;">
                                ì‚­ì œ
                            </button>
                        </div>
                `;

                // ìŒì‹ ëª©ë¡
                mealGroup.foods.forEach(food => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(46, 125, 50, 0.1); box-sizing: border-box; width: 100%;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="color: #333; font-weight: 500; word-break: break-word;">${food.foodName}</div>
                                <div style="color: #999; font-size: 0.85rem;">${food.quantity ? food.quantity + 'g' : ''}</div>
                            </div>
                            <div style="text-align: right; flex-shrink: 0; margin-left: 1rem;">
                                <div style="color: #2E7D32; font-weight: 600;">${Math.round(food.totalCalories || 0)} kcal</div>
                                <button class="btn-edit-meal" onclick="openEditMealDetailModal(${food.recordId}, '${food.foodName}', ${food.quantity}, '${mealGroup.mealType}', '${mealGroup.intakeTime}')" style="background: #2E7D32; color: white; border: none; padding: 0.2rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-top: 0.3rem;">
                                    ìˆ˜ì •
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            });

            // ì‹ì‚¬ ì¶”ê°€ ë²„íŠ¼
            html += `
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd; display: flex; justify-content: stretch; box-sizing: border-box; width: 100%;">
                    <button class="btn-add" onclick="addMealToDate('${dateStr}')" style="flex: 1; background: linear-gradient(135deg, #66bb6a 0%, #2e7d32 100%); color: white; border: none; padding: 0.8rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        + ì‹ì‚¬ ì¶”ê°€
                    </button>
                </div>
            `;

            html += '</div>';

            container.innerHTML = html;
        }

        // ì‹ì‚¬ ê¸°ë¡ ì‚­ì œ
        async function deleteMealRecord(recordId, dateStr) {
            if (!confirm('ì´ ì‹ì‚¬ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/meal-records/${recordId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log('âœ… ì‹ì‚¬ ê¸°ë¡ ì‚­ì œ ì™„ë£Œ');
                    alert('ì‹ì‚¬ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

                    // ë‹¬ë ¥ ìƒˆë¡œê³ ì¹¨
                    await loadMealRecords(userInfo.userId || userInfo.id);
                    renderCalendar();

                    // ëª¨ë‹¬ ë‹«ê¸°
                    closeMealEditModal();
                } else {
                    console.error('âŒ ì‚­ì œ ì‹¤íŒ¨:', response.status);
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‹ì‚¬ ê¸°ë¡ ìˆ˜ì • í¼ ì—´ê¸° (ëª¨ë‹¬ í˜•íƒœ)
        function openEditMealDetailModal(recordId, foodName, quantity, mealType, intakeTime) {
            currentEditingMealRecordId = recordId;

            // ëª¨ë‹¬ ì…ë ¥ í•„ë“œ ì±„ìš°ê¸°
            document.getElementById('editFoodName').value = foodName;
            document.getElementById('editMealType').value = mealType;
            document.getElementById('editQuantity').value = quantity;

            // ì‹œê°„ í¬ë§· ë³€í™˜ (HH:mm:ss -> HH:mm)
            const timeOnly = intakeTime ? intakeTime.substring(0, 5) : '12:00';
            document.getElementById('editIntakeTime').value = timeOnly;

            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('mealDetailEditModal').style.display = 'block';
        }

        // ì‹ì‚¬ ê¸°ë¡ ìˆ˜ì • í¼ ì œì¶œ í•¸ë“¤ëŸ¬
        function setupMealDetailEditFormListener() {
            const form = document.getElementById('mealDetailEditForm');
            if (form && !form.dataset.listenerAdded) {
                form.dataset.listenerAdded = 'true';
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    if (currentEditingMealRecordId === null) {
                        alert('ì˜¤ë¥˜: ìˆ˜ì •í•  ì‹ì‚¬ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    const mealType = document.getElementById('editMealType').value;
                    const intakeTime = document.getElementById('editIntakeTime').value + ':00';
                    const quantity = parseFloat(document.getElementById('editQuantity').value);

                    if (!mealType || !intakeTime || !quantity) {
                        alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    await updateMealRecord(currentEditingMealRecordId, quantity, mealType, intakeTime);
                    closeMealDetailEditModal();
                });
            }
        }

        // ì‹ì‚¬ ê¸°ë¡ ìˆ˜ì •
        async function updateMealRecord(recordId, quantity, mealType, intakeTime) {
            try {
                const response = await fetch(`/api/meal-records/${recordId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        quantity: quantity,
                        mealType: mealType,
                        intakeTime: intakeTime
                    })
                });

                if (response.ok) {
                    console.log('âœ… ì‹ì‚¬ ê¸°ë¡ ìˆ˜ì • ì™„ë£Œ');
                    alert('ì‹ì‚¬ ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');

                    // ë‹¬ë ¥ ìƒˆë¡œê³ ì¹¨
                    await loadMealRecords(userInfo.userId || userInfo.id);
                    renderCalendar();

                    // ì˜¤ëŠ˜ì˜ ì˜ì–‘ì†Œ ì •ë³´ ìƒˆë¡œê³ ì¹¨
                    await loadTodayNutrients(userInfo.userId || userInfo.id);

                    // ëª¨ë‹¬ ë‹«ê¸°
                    closeMealEditModal();
                } else {
                    console.error('âŒ ìˆ˜ì • ì‹¤íŒ¨:', response.status);
                    alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜:', error);
                alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë¹ˆ ë‚ ì§œì— ì‹ì‚¬ ì¶”ê°€
        function openAddMealForDateModal(dateStr) {
            // ë‚ ì§œë¥¼ í¬ë§·íŒ…
            const date = new Date(dateStr + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });

            // ê°„ë‹¨í•œ í™•ì¸ í›„ ì‹ì‚¬ ì¶”ê°€ í˜ì´ì§€ë¡œ ì´ë™
            const confirmed = confirm(`${formattedDate}ì— ì‹ì‚¬ë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (confirmed) {
                // localStorageì— ì„ íƒëœ ë‚ ì§œ ì €ì¥
                localStorage.setItem('selectedMealDate', dateStr);
                window.location.href = '/add-meal';
            }
        }

        // ë‚ ì§œì— ìƒˆë¡œìš´ ì‹ì‚¬ ì¶”ê°€
        function addMealToDate(dateStr) {
            // localStorageì— ì„ íƒëœ ë‚ ì§œ ì €ì¥
            localStorage.setItem('selectedMealDate', dateStr);
            closeMealEditModal();
            window.location.href = '/add-meal';
        }

        // ì•Œë¦¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸ (ì„ì‹œ - ë‚˜ì¤‘ì— APIë¡œ ë³€ê²½)
        function updateNotificationBadge() {
            // í˜„ì¬ëŠ” í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ 0ìœ¼ë¡œ ì„¤ì •
            // ë‚˜ì¤‘ì— APIì—ì„œ ì½ì§€ì•Šì€ ì•Œë¦¼ ê°œìˆ˜ë¥¼ ë°›ì•„ì„œ ì—…ë°ì´íŠ¸
            const unreadCount = 0;
            document.getElementById('notificationBadge').textContent = unreadCount;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        window.addEventListener('load', function() {
            updateNotificationBadge();
        });
    </script>
</body>
</html>
