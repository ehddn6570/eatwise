<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EatWise - ì‹ì‚¬ ê¸°ë¡</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        .meal-records-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 20px;
        }

        .meal-record-item {
            background: rgba(255,255,255,0.96);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.05);
            border-left: 4px solid #2E7D32;
        }

        .meal-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .meal-date-time {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .meal-date {
            font-size: 1rem;
            color: #333;
            font-weight: 600;
        }

        .meal-time {
            font-size: 0.9rem;
            color: #666;
            background: #f7fbf1;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
        }

        .meal-type {
            display: inline-block;
            font-size: 1.2rem;
        }

        .meal-foods {
            margin-top: 0.5rem;
        }

        .food-item-record {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            color: #666;
            font-size: 0.95rem;
        }

        .food-name {
            color: #333;
            font-weight: 500;
        }

        .food-calories {
            color: #2E7D32;
            font-weight: 600;
        }

        .empty-records {
            text-align: center;
            padding: 3rem 1rem;
            color: #999;
        }

        .empty-records p {
            margin-bottom: 0.5rem;
        }

        .btn-back {
            background: linear-gradient(135deg, #66bb6a 0%, #2e7d32 100%);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 1.5rem;
            transition: transform 0.3s;
        }

        .btn-back:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">EatWise</h1>
            <div class="nav-menu">
                <a href="/dashboard" class="nav-item">ëŒ€ì‹œë³´ë“œ</a>
                <a href="/restaurant-map" class="nav-item">ìŒì‹ì  ì§€ë„</a>
                <a href="/report" class="nav-item active">ë ˆí¬íŠ¸</a>
                <a href="/edit-profile" class="nav-item">ì •ë³´ ìˆ˜ì •</a>
                <button class="btn-notification" onclick="openNotifications()">
                    ğŸ”” ì•Œë¦¼
                    <span class="notification-badge" id="notificationBadge">0</span>
                </button>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </nav>

    <div class="meal-records-container">
        <button class="btn-back" onclick="goBack()">â† ë’¤ë¡œê°€ê¸°</button>

        <h2 style="color: #2E7D32; margin-bottom: 1.5rem;">ìµœê·¼ ì‹ì‚¬ ê¸°ë¡</h2>

        <div id="mealRecordsContent">
            <div class="empty-records">
                <p>ğŸ“ ë¡œë”© ì¤‘...</p>
            </div>
        </div>
    </div>

    <script>
        let userInfo = null;

        window.onload = function() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/';
                return;
            }

            try {
                userInfo = JSON.parse(userStr);
                loadMealRecords(userInfo.userId || userInfo.id);
            } catch (e) {
                console.error('ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì‹¤íŒ¨:', e);
                window.location.href = '/';
            }
        };

        // ìµœê·¼ 7ê°œ ì‹ì‚¬ ê¸°ë¡ ì¡°íšŒ
        async function loadMealRecords(userId) {
            try {
                // ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
                const today = new Date();
                const endDate = today.getFullYear() + '-' +
                               String(today.getMonth() + 1).padStart(2, '0') + '-' +
                               String(today.getDate()).padStart(2, '0');

                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const startDate = thirtyDaysAgo.getFullYear() + '-' +
                                 String(thirtyDaysAgo.getMonth() + 1).padStart(2, '0') + '-' +
                                 String(thirtyDaysAgo.getDate()).padStart(2, '0');

                console.log('ğŸ” ì¡°íšŒ ë²”ìœ„:', startDate, '~', endDate);

                const response = await fetch(`/api/meal-records/user/${userId}/date-range?startDate=${startDate}&endDate=${endDate}`);

                if (response.ok) {
                    const allRecords = await response.json();

                    // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
                    const sortedRecords = allRecords.sort((a, b) => {
                        const dateTimeA = new Date(`${a.intakeDate}T${a.intakeTime}`);
                        const dateTimeB = new Date(`${b.intakeDate}T${b.intakeTime}`);
                        return dateTimeB - dateTimeA;
                    });

                    // ìµœê·¼ 7ê°œë§Œ ì„ íƒ
                    const recentRecords = sortedRecords.slice(0, 7);
                    console.log('ğŸ“ ì¡°íšŒëœ ì‹ì‚¬ ê¸°ë¡:', recentRecords);
                    displayMealRecords(recentRecords);
                } else {
                    console.error('âŒ ì‹ì‚¬ ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨:', response.status);
                    showError('ì‹ì‚¬ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ ì‹ì‚¬ ê¸°ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
                showError('ì‹ì‚¬ ê¸°ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‹ì‚¬ ê¸°ë¡ í‘œì‹œ
        function displayMealRecords(records) {
            const content = document.getElementById('mealRecordsContent');

            if (records.length === 0) {
                content.innerHTML = `
                    <div class="empty-records">
                        <p>ğŸ“ ì•„ì§ ê¸°ë¡ëœ ì‹ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p>ì²« ì‹ì‚¬ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”!</p>
                    </div>
                `;
                return;
            }

            const mealTypeEmoji = {
                'BREAKFAST': 'ğŸŒ…',
                'LUNCH': 'â˜€ï¸',
                'DINNER': 'ğŸŒ™',
                'SNACK': 'ğŸª'
            };

            // ì‹ì‚¬ë¥¼ ë‚ ì§œ + ì‹œê°„ + ì‹ì‚¬ìœ í˜•ìœ¼ë¡œ ê·¸ë£¹í™”
            const groupedMeals = {};
            records.forEach(record => {
                const key = `${record.intakeDate}_${record.intakeTime}_${record.mealType}`;
                if (!groupedMeals[key]) {
                    groupedMeals[key] = {
                        intakeDate: record.intakeDate,
                        intakeTime: record.intakeTime,
                        mealType: record.mealType,
                        totalCalories: 0,
                        foods: []
                    };
                }

                // ìŒì‹ ì¶”ê°€
                if (record.foods && record.foods.length > 0) {
                    groupedMeals[key].foods.push(...record.foods);
                } else if (record.foodName) {
                    groupedMeals[key].foods.push({
                        foodId: record.foodId,
                        foodName: record.foodName,
                        calories: record.totalCalories,
                        quantity: record.quantity
                    });
                }

                // ì´ ì¹¼ë¡œë¦¬ í•©ì‚°
                groupedMeals[key].totalCalories += (record.totalCalories || 0);
            });

            // ê·¸ë£¹í™”ëœ ì‹ì‚¬ë“¤ì„ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
            const groupedArray = Object.values(groupedMeals).sort((a, b) => {
                const dateTimeA = new Date(`${a.intakeDate}T${a.intakeTime}`);
                const dateTimeB = new Date(`${b.intakeDate}T${b.intakeTime}`);
                return dateTimeB - dateTimeA;
            });

            content.innerHTML = groupedArray.map(meal => {
                const mealTypeUpper = meal.mealType ? meal.mealType.toUpperCase() : 'LUNCH';
                const emoji = mealTypeEmoji[mealTypeUpper] || 'ğŸ½ï¸';
                return `
                <div class="meal-record-item">
                    <div class="meal-record-header">
                        <div class="meal-date-time">
                            <div class="meal-date">${emoji} ${formatDate(meal.intakeDate)}</div>
                            <div class="meal-time">
                                ${getMealTypeLabel(meal.mealType)} ${formatTime(meal.intakeTime)}
                            </div>
                        </div>
                        <div style="color: #2E7D32; font-weight: 600; font-size: 1.1rem;">
                            ${Math.round(meal.totalCalories)} kcal
                        </div>
                    </div>
                    <div class="meal-foods">
                        ${meal.foods && meal.foods.length > 0 ?
                            meal.foods.map(food => `
                                <div class="food-item-record">
                                    <span class="food-name">${food.foodName}</span>
                                    <span class="food-calories">${food.calories ? Math.round(food.calories) : 0} kcal</span>
                                </div>
                            `).join('') :
                            '<div class="food-item-record"><span class="food-name">ì‹ì‚¬ ì •ë³´ ì—†ìŒ</span></div>'
                        }
                    </div>
                </div>
                `;
            }).join('');
        }

        // ë‚ ì§œ í¬ë§·
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'short'
            });
        }

        // ì‹œê°„ í¬ë§·
        function formatTime(timeStr) {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            return `${hours}:${minutes}`;
        }

        // ì‹ì‚¬ ìœ í˜• ë¼ë²¨
        function getMealTypeLabel(mealType) {
            const labels = {
                'BREAKFAST': 'ì•„ì¹¨',
                'LUNCH': 'ì ì‹¬',
                'DINNER': 'ì €ë…',
                'SNACK': 'ê°„ì‹'
            };
            return labels[mealType] || 'ì‹ì‚¬';
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            const content = document.getElementById('mealRecordsContent');
            content.innerHTML = `
                <div class="empty-records">
                    <p>âŒ ${message}</p>
                </div>
            `;
        }

        // ë’¤ë¡œê°€ê¸°
        function goBack() {
            window.location.href = '/dashboard';
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('user');
                window.location.href = '/';
            }
        }

        // ì•Œë¦¼ í•¨ìˆ˜ (ë„¤ë¹„ê²Œì´ì…˜ í˜¸í™˜ì„±)
        function openNotifications() {
            alert('ì•Œë¦¼ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
        }
    </script>
</body>
</html>

