<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EatWise - ë ˆí¬íŠ¸</title>
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        .report-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .report-container.monthly-mode {
            grid-template-columns: 1fr 1fr;
        }

        .report-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .report-card:nth-child(2) {
            justify-content: space-between;
        }

        .report-title {
            font-size: 1.15em;
            font-weight: 600;
            color: #2E7D32;
            margin-bottom: 13px;
            border-bottom: 2px solid #d4f2c2;
            padding-bottom: 7px;
        }

        .meal-records-list {
            height: 750px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .meal-record-item {
            padding: 12px;
            border-left: 4px solid #2E7D32;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .meal-record-item:hover {
            background: #f0f8f0;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.15);
        }

        .meal-date {
            font-weight: 600;
            color: #2E7D32;
            font-size: 0.92em;
        }

        .meal-type {
            display: inline-block;
            background: #2E7D32;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin: 5px 0;
        }

        .meal-food {
            color: #555;
            font-size: 0.87em;
            margin: 5px 0;
        }

        .meal-calories {
            color: #d4af37;
            font-weight: 600;
            font-size: 0.87em;
        }

        .analysis-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 13px;
            margin-bottom: 14px;
        }

        .analysis-box {
            background: linear-gradient(135deg, #f7fbf1 0%, #d4f2c2 100%);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #2E7D32;
        }

        .analysis-label {
            font-size: 0.82em;
            color: #555;
            margin-bottom: 4px;
        }

        .analysis-value {
            font-size: 1.45em;
            font-weight: 700;
            color: #2E7D32;
        }

        .analysis-unit {
            font-size: 0.78em;
            color: #777;
        }

        .nutrient-analysis {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .nutrient-box {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            text-align: center;
        }

        .nutrient-name {
            font-size: 0.77em;
            color: #555;
            margin-bottom: 4px;
        }

        .nutrient-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #2E7D32;
        }

        .nutrient-goal {
            font-size: 0.7em;
            color: #999;
        }

        .weekly-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(38px, 1fr));
            gap: 3px;
            margin-top: 12px;
        }

        .weekly-chart.monthly-mode {
            grid-template-columns: repeat(auto-fit, minmax(20px, 1fr));
            gap: 1px;
        }

        .chart-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            height: 110px;
        }

        .bar-fill {
            width: 23px;
            background: linear-gradient(180deg, #2E7D32 0%, #4caf50 100%);
            border-radius: 4px 4px 0 0;
            transition: all 0.3s ease;
            min-height: 14px;
        }

        .bar-fill:hover {
            opacity: 0.8;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);
        }

        .bar-label {
            font-size: 0.6em;
            color: #555;
            margin-top: 3px;
            text-align: center;
        }

        .bar-value {
            font-size: 0.6em;
            color: #2E7D32;
            font-weight: 600;
            margin-top: 2px;
        }

        .week-range {
            text-align: center;
            color: #666;
            font-size: 0.8em;
            margin-bottom: 7px;
        }

        .habit-advice-section {
            margin-top: 18px;
            padding: 14px;
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            border-radius: 12px;
            border-left: 4px solid #ffc107;
        }

        .habit-advice-title {
            font-size: 0.97em;
            font-weight: 600;
            color: #ff6b35;
            margin-bottom: 11px;
            display: flex;
            align-items: center;
            gap: 7px;
        }

        .advice-item {
            background: white;
            padding: 9px;
            border-radius: 8px;
            margin-bottom: 7px;
            border-left: 3px solid #ffc107;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .advice-item:last-child {
            margin-bottom: 0;
        }

        .advice-emoji {
            display: inline-block;
            font-size: 0.95em;
            margin-right: 5px;
        }

        .advice-text {
            color: #333;
            font-size: 0.8em;
            line-height: 1.35;
        }

        .advice-priority {
            display: inline-block;
            font-size: 0.62em;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 5px;
            font-weight: 600;
        }

        .priority-high {
            background: #ffebee;
            color: #c62828;
        }

        .priority-medium {
            background: #fff3e0;
            color: #e65100;
        }

        .priority-low {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .period-btn {
            padding: 10px 20px;
            border: 2px solid #2E7D32;
            background: white;
            color: #2E7D32;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .period-btn:hover {
            background: #f0f8f0;
        }

        .period-btn.active {
            background: #2E7D32;
            color: white;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
        }

        @media (max-width: 1200px) {
            .report-container {
                grid-template-columns: 1fr;
            }

            .nutrient-analysis {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-logo">EatWise</h1>
            <div class="nav-menu">
                <a href="/dashboard" class="nav-item">ëŒ€ì‹œë³´ë“œ</a>
                <a href="/restaurant-map" class="nav-item">ìŒì‹ì  ì§€ë„</a>
                <a href="/report" class="nav-item active">ë ˆí¬íŠ¸</a>
                <a href="/edit-profile" class="nav-item">ì •ë³´ ìˆ˜ì •</a>
                <button class="btn-notification" onclick="openNotifications()">
                    ğŸ”” ì•Œë¦¼
                    <span class="notification-badge" id="notificationBadge">0</span>
                </button>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="welcome-section">
            <h2 id="pageTitle">ì£¼ê°„ ì‹ì‚¬ ë¶„ì„ ë ˆí¬íŠ¸</h2>
            <p>ìµœê·¼ 7ì¼ê°„ì˜ ì‹ì‚¬ ê¸°ë¡ê³¼ ì˜ì–‘ì†Œ ë¶„ì„</p>
        </div>

        <div class="period-selector">
            <button class="period-btn active" onclick="changePeriod('week')">ì´ë²ˆ ì£¼</button>
            <button class="period-btn" onclick="changePeriod('month')">ì´ë²ˆ ë‹¬</button>
        </div>

        <div class="report-container">
            <!-- ì™¼ìª½: ì‹ì‚¬ ê¸°ë¡ -->
            <div class="report-card">
                <div class="report-title" id="mealRecordsTitle">ğŸ“‹ ìµœê·¼ ì‹ì‚¬ ê¸°ë¡</div>
                <div id="mealRecordsList" class="meal-records-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ½ï¸</div>
                        <p>ì‹ì‚¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ë¶„ì„ -->
            <div class="report-card">
                <div class="report-title" id="analysisTitle">ğŸ“Š ì£¼ê°„ ë¶„ì„</div>

                <!-- ì´ ì¹¼ë¡œë¦¬ ë¶„ì„ -->
                <div class="analysis-section">
                    <div class="analysis-box">
                        <div class="analysis-label">ì´ ì„­ì·¨ ì¹¼ë¡œë¦¬</div>
                        <div class="analysis-value">
                            <span id="totalCalories">0</span>
                            <span class="analysis-unit">kcal</span>
                        </div>
                    </div>
                    <div class="analysis-box">
                        <div class="analysis-label">í‰ê·  ì¼ì¼ ì¹¼ë¡œë¦¬</div>
                        <div class="analysis-value">
                            <span id="avgCalories">0</span>
                            <span class="analysis-unit">kcal</span>
                        </div>
                    </div>
                </div>

                <!-- ì˜ì–‘ì†Œ ë¶„ì„ -->
                <div class="nutrient-analysis">
                    <div class="nutrient-box">
                        <div class="nutrient-name">íƒ„ìˆ˜í™”ë¬¼</div>
                        <div style="display: flex; justify-content: center; align-items: baseline; gap: 3px;">
                            <div class="nutrient-value" id="totalCarbs">0</div>
                            <div class="nutrient-goal">g (ì´)</div>
                        </div>
                        <div style="font-size: 0.85em; color: #2E7D32; margin-top: 5px; font-weight: 600;">
                            <span id="avgCarbs">0</span>g/ì¼
                        </div>
                    </div>
                    <div class="nutrient-box">
                        <div class="nutrient-name">ë‹¨ë°±ì§ˆ</div>
                        <div style="display: flex; justify-content: center; align-items: baseline; gap: 3px;">
                            <div class="nutrient-value" id="totalProtein">0</div>
                            <div class="nutrient-goal">g (ì´)</div>
                        </div>
                        <div style="font-size: 0.85em; color: #2E7D32; margin-top: 5px; font-weight: 600;">
                            <span id="avgProtein">0</span>g/ì¼
                        </div>
                    </div>
                    <div class="nutrient-box">
                        <div class="nutrient-name">ì§€ë°©</div>
                        <div style="display: flex; justify-content: center; align-items: baseline; gap: 3px;">
                            <div class="nutrient-value" id="totalFat">0</div>
                            <div class="nutrient-goal">g (ì´)</div>
                        </div>
                        <div style="font-size: 0.85em; color: #2E7D32; margin-top: 5px; font-weight: 600;">
                            <span id="avgFat">0</span>g/ì¼
                        </div>
                    </div>
                </div>

                <!-- ì£¼ê°„ ì¹¼ë¡œë¦¬ ì°¨íŠ¸ -->
                <div style="margin-top: 30px;">
                    <div class="report-title" id="chartTitle" style="border: none; margin: 0 0 10px 0;">ğŸ“ˆ ì£¼ê°„ ì¹¼ë¡œë¦¬ ì¶”ì´</div>
                    <div class="week-range" id="weekRange"></div>
                    <div class="weekly-chart" id="weeklyChart"></div>
                </div>

                <!-- ì‹ìŠµê´€ ê°œì„  ì¡°ì–¸ ì„¹ì…˜ -->
                <div class="habit-advice-section" id="habitAdviceSection" style="display: none;">
                    <div class="habit-advice-title">
                        <span>ğŸ½ï¸ ì‹ìŠµê´€ ê°œì„  ì¡°ì–¸</span>
                    </div>
                    <div id="adviceList">
                        <!-- ì¡°ì–¸ í•­ëª©ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        let userId = null;
        let currentPeriod = 'week';

        // ìŒì‹ ì¹´í…Œê³ ë¦¬ë¥¼ í•œê¸€ë¡œ ë³€í™˜
        function getCategoryInKorean(category) {
            const categoryMap = {
                'korean': 'í•œì‹',
                'western': 'ì–‘ì‹',
                'japanese': 'ì¼ì‹',
                'chinese': 'ì¤‘ì‹',
                'beverage': 'ìŒë£Œ',
                'í•œì‹': 'í•œì‹',
                'ì–‘ì‹': 'ì–‘ì‹',
                'ì¼ì‹': 'ì¼ì‹',
                'ì¤‘ì‹': 'ì¤‘ì‹',
                'ìŒë£Œ': 'ìŒë£Œ'
            };
            return categoryMap[category] || category || 'ê¸°íƒ€';
        }

        // ì‹ì‚¬ ìœ í˜•ì„ í•œê¸€ë¡œ ë³€í™˜
        function getMealTypeInKorean(mealType) {
            const mealTypeMap = {
                'breakfast': 'ì•„ì¹¨',
                'lunch': 'ì ì‹¬',
                'dinner': 'ì €ë…',
                'snack': 'ê°„ì‹'
            };
            return mealTypeMap[mealType] || mealType || 'ì‹ì‚¬';
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            const userStr = localStorage.getItem('user');

            if (!userStr) {
                window.location.href = '/login';
                return;
            }

            try {
                const user = JSON.parse(userStr);
                userId = user.userId || user.id;

                if (!userId) {
                    window.location.href = '/login';
                    return;
                }

                loadReportData();
            } catch (e) {
                console.error('ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì‹¤íŒ¨:', e);
                window.location.href = '/login';
            }
        });

        // ê¸°ê°„ ë³€ê²½
        function changePeriod(period) {
            console.log('ğŸ”„ ê¸°ê°„ ë³€ê²½:', period); // ë””ë²„ê¹… ë¡œê·¸
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // í˜ì´ì§€ ì œëª© ë° ì„¤ëª… ì—…ë°ì´íŠ¸
            const pageTitle = document.getElementById('pageTitle');
            const pageParagraph = document.querySelector('.welcome-section p');
            const mealRecordsTitle = document.getElementById('mealRecordsTitle');
            const reportContainer = document.querySelector('.report-container');

            if (period === 'week') {
                pageTitle.textContent = 'ì£¼ê°„ ì‹ì‚¬ ë¶„ì„ ë ˆí¬íŠ¸';
                pageParagraph.textContent = 'ìµœê·¼ 7ì¼ê°„ì˜ ì‹ì‚¬ ê¸°ë¡ê³¼ ì˜ì–‘ì†Œ ë¶„ì„';
                mealRecordsTitle.textContent = 'ğŸ“‹ ìµœê·¼ ì‹ì‚¬ ê¸°ë¡';
                reportContainer.classList.remove('monthly-mode');
            } else if (period === 'month') {
                pageTitle.textContent = 'ì›”ê°„ ì‹ì‚¬ ë¶„ì„ ë ˆí¬íŠ¸';
                pageParagraph.textContent = 'í˜„ì¬ ë‹¬ì˜ ëª¨ë“  ì‹ì‚¬ ê¸°ë¡ê³¼ ì˜ì–‘ì†Œ ë¶„ì„';
                mealRecordsTitle.textContent = 'ğŸ“‹ ì›”ê°„ ì‹ì‚¬ ê¸°ë¡';
                reportContainer.classList.add('monthly-mode');
            }

            // ë¶„ì„ ì œëª© ì—…ë°ì´íŠ¸
            const titleElement = document.getElementById('analysisTitle');
            if (period === 'week') {
                titleElement.textContent = 'ğŸ“Š ì£¼ê°„ ë¶„ì„';
            } else if (period === 'month') {
                titleElement.textContent = 'ğŸ“Š ì›”ê°„ ë¶„ì„';
            }

            loadReportData();
        }

        // ë ˆí¬íŠ¸ ë°ì´í„° ë¡œë“œ
        async function loadReportData() {
            try {
                const token = localStorage.getItem('token');

                // ê¸°ê°„ ê³„ì‚°
                const today = new Date();
                let queryStartDate = new Date();
                let queryEndDate = new Date(today);

                if (currentPeriod === 'week') {
                    queryStartDate.setDate(queryEndDate.getDate() - 7);
                } else {
                    // ì›”ê°„: í˜„ì¬ ë‹¬ì˜ 1ì¼ë¶€í„° ì˜¤ëŠ˜ê¹Œì§€
                    queryStartDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    // queryEndDateëŠ” ì´ë¯¸ ì˜¤ëŠ˜ ë‚ ì§œ
                }

                const startDateStr = queryStartDate.toISOString().split('T')[0];
                const endDateStr = queryEndDate.toISOString().split('T')[0];

                console.log('ğŸ“… ì¡°íšŒ ê¸°ê°„:', startDateStr, '~', endDateStr, '| ëª¨ë“œ:', currentPeriod);

                // API í˜¸ì¶œ
                const response = await fetch(`/api/meal-records/period?userId=${userId}&startDate=${startDateStr}&endDate=${endDateStr}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }

                const mealRecords = await response.json();

                // ë°ì´í„° ë¶„ì„ ë° í‘œì‹œ
                analyzeMealRecords(mealRecords, queryStartDate, queryEndDate);
                displayMealRecords(mealRecords);
                displayWeeklyChart(mealRecords, queryStartDate, queryEndDate);


            } catch (error) {
                console.error('ë ˆí¬íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì‹ì‚¬ ê¸°ë¡ ë¶„ì„
        function analyzeMealRecords(mealRecords, startDate, endDate) {
            let totalCalories = 0;
            let totalCarbs = 0;
            let totalProtein = 0;
            let totalFat = 0;

            mealRecords.forEach(record => {
                totalCalories += record.totalCalories || 0;
                if (record.food) {
                    // quantityëŠ” ê·¸ë¨ ë‹¨ìœ„ì´ê³ , ì˜ì–‘ì†ŒëŠ” 100g ê¸°ì¤€ì´ë¯€ë¡œ / 100 í•„ìš”
                    const quantityRatio = (record.quantity || 0) / 100;
                    totalCarbs += (record.food.carbs || 0) * quantityRatio;
                    totalProtein += (record.food.protein || 0) * quantityRatio;
                    totalFat += (record.food.fat || 0) * quantityRatio;
                }
            });

            const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const avgCalories = days > 0 ? Math.round(totalCalories / days) : 0;
            const avgCarbs = days > 0 ? (totalCarbs / days).toFixed(1) : 0;
            const avgProtein = days > 0 ? (totalProtein / days).toFixed(1) : 0;
            const avgFat = days > 0 ? (totalFat / days).toFixed(1) : 0;

            document.getElementById('totalCalories').textContent = Math.round(totalCalories);
            document.getElementById('avgCalories').textContent = avgCalories;
            document.getElementById('totalCarbs').textContent = Math.round(totalCarbs);
            document.getElementById('avgCarbs').textContent = avgCarbs;
            document.getElementById('totalProtein').textContent = Math.round(totalProtein);
            document.getElementById('avgProtein').textContent = avgProtein;
            document.getElementById('totalFat').textContent = Math.round(totalFat);
            document.getElementById('avgFat').textContent = avgFat;
        }

        // ì‹ì‚¬ ê¸°ë¡ í‘œì‹œ
        function displayMealRecords(mealRecords) {
            const container = document.getElementById('mealRecordsList');

            if (mealRecords.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ½ï¸</div>
                        <p>ì´ ê¸°ê°„ì˜ ì‹ì‚¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            // ì‹ì‚¬ ê¸°ë¡ì„ ì‹œê°„ ì—­ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
            const sortedRecords = [...mealRecords].sort((a, b) => {
                const dateTimeA = new Date(`${a.intakeDate}T${a.intakeTime || '00:00:00'}`);
                const dateTimeB = new Date(`${b.intakeDate}T${b.intakeTime || '00:00:00'}`);
                return dateTimeB - dateTimeA; // ì—­ìˆœ (ìµœì‹ ì´ ìœ„)
            });

            let html = '';
            sortedRecords.forEach(record => {
                const date = new Date(record.intakeDate).toLocaleDateString('ko-KR');
                const mealTypeEmoji = getMealTypeEmoji(record.mealType);
                const mealTypeKorean = getMealTypeInKorean(record.mealType);
                const foodName = record.food?.foodName || 'ìŒì‹ ì •ë³´ ì—†ìŒ';
                html += `
                    <div class="meal-record-item">
                        <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">${date}</div>
                        <div class="meal-date">${mealTypeEmoji} ${mealTypeKorean}</div>
                        <div class="meal-food">ğŸ– ${foodName}</div>
                        <div class="meal-calories">ì¹¼ë¡œë¦¬: ${record.totalCalories || 0} kcal</div>
                    </div>
                `;
            });


            container.innerHTML = html;
        }

        // ë¡œì»¬ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ì£¼ê°„/ì›”ê°„ ì¹¼ë¡œë¦¬ ì°¨íŠ¸ í‘œì‹œ
        function displayWeeklyChart(mealRecords, startDate, endDate) {
            // ë‚ ì§œë³„ ì¹¼ë¡œë¦¬ í•©ê³„ ê³„ì‚°
            const dailyCalories = {};
            const days = [];

            // ê¸°ê°„ ë‚´ ëª¨ë“  ë‚ ì§œ ìƒì„±
            const currentDate = new Date(startDate);
            const endDateStr = formatLocalDate(endDate);

            while (formatLocalDate(currentDate) <= endDateStr) {
                const dateStr = formatLocalDate(currentDate);
                dailyCalories[dateStr] = 0;
                days.push(dateStr);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            mealRecords.forEach(record => {
                const dateStr = record.intakeDate;
                if (dailyCalories.hasOwnProperty(dateStr)) {
                    dailyCalories[dateStr] += record.totalCalories || 0;
                }
            });

            const maxCalories = Math.max(...Object.values(dailyCalories), 2000);
            let chartHtml = '';

            // ì›”ê°„ ëª¨ë“œì¸ ê²½ìš° ì°¨íŠ¸ ë°”ì˜ ë†’ì´ë¥¼ ì¡°ì •
            const isMonthly = currentPeriod === 'month';
            const barHeight = 150;  // ì£¼ê°„, ì›”ê°„ ëª¨ë‘ ë™ì¼í•œ ë†’ì´
            const barWidth = isMonthly ? 20 : 30;

            days.forEach(dateStr => {
                const date = new Date(dateStr);
                const dayName = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
                const calories = dailyCalories[dateStr];
                const height = (calories / maxCalories) * barHeight;

                chartHtml += `
                    <div class="chart-bar" style="height: ${barHeight}px;">
                        <div class="bar-fill" style="height: ${height}px; width: ${barWidth}px;" title="${calories} kcal"></div>
                        <div class="bar-label" style="font-size: ${isMonthly ? '0.65em' : '0.75em'};">${date.getDate()}ì¼</div>
                        <div class="bar-value" style="font-size: ${isMonthly ? '0.65em' : '0.75em'};">${Math.round(calories)}<br>kcal</div>
                    </div>
                `;
            });

            const chartContainer = document.getElementById('weeklyChart');
            chartContainer.innerHTML = chartHtml;

            // ì›”ê°„ ëª¨ë“œì¼ ë•Œ í´ë˜ìŠ¤ ì¶”ê°€
            if (isMonthly) {
                chartContainer.classList.add('monthly-mode');
            } else {
                chartContainer.classList.remove('monthly-mode');
            }

            // ì£¼ê°„ ë²”ìœ„ í‘œì‹œ ë° ì°¨íŠ¸ ì œëª© ì—…ë°ì´íŠ¸
            const startStr = startDate.toLocaleDateString('ko-KR');
            const endStr = endDate.toLocaleDateString('ko-KR');
            document.getElementById('weekRange').textContent = `${startStr} ~ ${endStr}`;

            // ì°¨íŠ¸ ì œëª© ì—…ë°ì´íŠ¸
            const chartTitleElement = document.getElementById('chartTitle');
            console.log('ğŸ“Š currentPeriod:', currentPeriod); // ë””ë²„ê¹… ë¡œê·¸
            if (currentPeriod === 'week') {
                chartTitleElement.textContent = 'ğŸ“ˆ ì£¼ê°„ ì¹¼ë¡œë¦¬ ì¶”ì´';
            } else if (currentPeriod === 'month') {
                chartTitleElement.textContent = 'ğŸ“ˆ ì›”ê°„ ì¹¼ë¡œë¦¬ ì¶”ì´';
            }
        }

        // ì‹ì‚¬ ìœ í˜• ì´ëª¨ì§€
        function getMealTypeEmoji(mealType) {
            const emojiMap = {
                'breakfast': 'ğŸŒ…',
                'lunch': 'â˜€ï¸',
                'dinner': 'ğŸŒ™',
                'snack': 'ğŸª'
            };
            return emojiMap[mealType] || 'ğŸ½ï¸';
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            window.location.href = '/login';
        }

        // ì•Œë¦¼ ì—´ê¸° (ê¸°ë³¸ êµ¬í˜„)
        function openNotifications() {
            alert('ì•Œë¦¼ ê¸°ëŠ¥ì€ ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.');
        }

        // ì‹ìŠµê´€ ê°œì„  ì¡°ì–¸ ë¡œë“œ - ì‚¬ìš©ì ì •ë³´ ê¸°ë°˜ìœ¼ë¡œ ê¶Œì¥ê°’ ê³„ì‚°í•˜ì—¬ ì¡°ì–¸ ìƒì„±
        async function loadHabitAdvice() {
            try {
                // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const userStr = localStorage.getItem('user');
                if (!userStr) {
                    console.log('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const user = JSON.parse(userStr);
                const height = user.height || 170; // cm
                const weight = user.weight || 65; // kg
                const gender = user.gender; // 'M' ë˜ëŠ” 'F'
                const age = user.age || 25;

                // BMR (ê¸°ì´ˆëŒ€ì‚¬ëŸ‰) ê³„ì‚° - Harris-Benedict ê³µì‹
                let bmr = 0;
                if (gender === 'M' || gender === 'MALE' || gender === 'm' || gender === 'male') {
                    // ë‚¨ì„±: BMR = 88.362 + (13.397 Ã— weight) + (4.799 Ã— height) - (5.677 Ã— age)
                    bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
                } else {
                    // ì—¬ì„±: BMR = 447.593 + (9.247 Ã— weight) + (3.098 Ã— height) - (4.330 Ã— age)
                    bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
                }

                // í™œë™ê³„ìˆ˜ ì ìš© (ë³´í†µ í™œë™ëŸ‰: 1.55)
                const recommendedCalories = Math.round(bmr * 1.55);

                // ê¶Œì¥ ì˜ì–‘ì†Œ ê³„ì‚°
                // íƒ„ìˆ˜í™”ë¬¼: ì „ì²´ ì¹¼ë¡œë¦¬ì˜ 50-60%
                // ë‹¨ë°±ì§ˆ: ì²´ì¤‘ 1kgë‹¹ 1.2-1.6g (ìš´ë™ëŸ‰ì— ë”°ë¼)
                // ì§€ë°©: ì „ì²´ ì¹¼ë¡œë¦¬ì˜ 20-30%
                const recommendedCarbs = Math.round((recommendedCalories * 0.55) / 4); // 1g = 4kcal
                const recommendedProtein = Math.round(weight * 1.4); // 1kgë‹¹ 1.4g
                const recommendedFat = Math.round((recommendedCalories * 0.25) / 9); // 1g = 9kcal

                console.log(`ğŸ“Š ì‚¬ìš©ì ì •ë³´: í‚¤=${height}cm, ì²´ì¤‘=${weight}kg, ì„±ë³„=${gender}, ë‚˜ì´=${age}`);
                console.log(`ğŸ’ª ê¶Œì¥ê°’: ì¹¼ë¡œë¦¬=${recommendedCalories}kcal, íƒ„=${recommendedCarbs}g, ë‹¨=${recommendedProtein}g, ì§€=${recommendedFat}g`);

                // í˜„ì¬ ì„­ì·¨ëŸ‰ ê°€ì ¸ì˜¤ê¸°
                const avgCarbsEl = document.getElementById('avgCarbs');
                const avgProteinEl = document.getElementById('avgProtein');
                const avgFatEl = document.getElementById('avgFat');

                const actualCarbs = parseFloat(avgCarbsEl.textContent) || 0;
                const actualProtein = parseFloat(avgProteinEl.textContent) || 0;
                const actualFat = parseFloat(avgFatEl.textContent) || 0;

                console.log(`ğŸ“ˆ ì‹¤ì œ ì„­ì·¨: íƒ„=${actualCarbs}g, ë‹¨=${actualProtein}g, ì§€=${actualFat}g`);

                // ì¡°ì–¸ ìƒì„±
                generateHabitAdvice(actualCarbs, actualProtein, actualFat, recommendedCarbs, recommendedProtein, recommendedFat);

            } catch (error) {
                console.error('ì‹ìŠµê´€ ê°œì„  ì¡°ì–¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê¶Œì¥ê°’ê³¼ ì‹¤ì œ ì„­ì·¨ëŸ‰ì„ ë¹„êµí•˜ì—¬ ì¡°ì–¸ ìƒì„±
        function generateHabitAdvice(actualCarbs, actualProtein, actualFat, recCarbs, recProtein, recFat) {
            const adviceList = document.getElementById('adviceList');
            adviceList.innerHTML = '';

            const advices = [];

            // íƒ„ìˆ˜í™”ë¬¼ ì¡°ì–¸ (ê¸°ì¤€: Â±10%)
            const carbDiff = actualCarbs - recCarbs;
            const carbRatio = Math.abs(carbDiff) / recCarbs * 100;

            if (carbRatio > 20) {
                // 20% ì´ìƒ ë²—ì–´ë‚¨ = ê¸´ê¸‰
                advices.push({
                    emoji: 'ğŸš',
                    text: `íƒ„ìˆ˜í™”ë¬¼ ì„­ì·¨ê°€ ${carbDiff > 0 ? 'ê³¼ë‹¤í•©ë‹ˆë‹¤' : 'ë¶€ì¡±í•©ë‹ˆë‹¤'}. í˜„ì¬: ${Math.round(actualCarbs)}g â†’ ê¶Œì¥: ${recCarbs}g (${Math.round(carbRatio)}% ${carbDiff > 0 ? 'ì´ˆê³¼' : 'ë¶€ì¡±'})`,
                    priority: 'high'
                });
            } else if (carbRatio > 10) {
                // 10~20% ë²”ìœ„ = ë³´í†µ
                advices.push({
                    emoji: 'ğŸš',
                    text: `íƒ„ìˆ˜í™”ë¬¼ ì„­ì·¨ê°€ ${carbDiff > 0 ? 'ì•½ê°„ ë†’ìŠµë‹ˆë‹¤' : 'ì•½ê°„ ë‚®ìŠµë‹ˆë‹¤'}. í˜„ì¬: ${Math.round(actualCarbs)}g â†’ ê¶Œì¥: ${recCarbs}g (${Math.round(carbRatio)}% ${carbDiff > 0 ? 'ì´ˆê³¼' : 'ë¶€ì¡±'})`,
                    priority: 'medium'
                });
            } else {
                // 10% ì´ë‚´ = ì ì ˆ
                advices.push({
                    emoji: 'âœ…',
                    text: `íƒ„ìˆ˜í™”ë¬¼ ì„­ì·¨ê°€ ì ì ˆí•©ë‹ˆë‹¤. í˜„ì¬: ${Math.round(actualCarbs)}g / ê¶Œì¥: ${recCarbs}g`,
                    priority: 'low'
                });
            }

            // ë‹¨ë°±ì§ˆ ì¡°ì–¸ (ê¸°ì¤€: Â±15%)
            const proteinDiff = actualProtein - recProtein;
            const proteinRatio = Math.abs(proteinDiff) / recProtein * 100;

            if (proteinRatio > 20) {
                // 20% ì´ìƒ ë²—ì–´ë‚¨ = ê¸´ê¸‰
                advices.push({
                    emoji: 'ğŸ¥©',
                    text: `ë‹¨ë°±ì§ˆ ì„­ì·¨ê°€ ${proteinDiff > 0 ? 'ê³¼ë‹¤í•©ë‹ˆë‹¤' : 'ë¶€ì¡±í•©ë‹ˆë‹¤'}. í˜„ì¬: ${Math.round(actualProtein)}g â†’ ê¶Œì¥: ${recProtein}g (${Math.round(proteinRatio)}% ${proteinDiff > 0 ? 'ì´ˆê³¼' : 'ë¶€ì¡±'})`,
                    priority: 'high'
                });
            } else if (proteinRatio > 15) {
                // 15~20% ë²”ìœ„ = ë³´í†µ
                advices.push({
                    emoji: 'ğŸ¥©',
                    text: `ë‹¨ë°±ì§ˆ ì„­ì·¨ê°€ ${proteinDiff > 0 ? 'ì•½ê°„ ë†’ìŠµë‹ˆë‹¤' : 'ì•½ê°„ ë‚®ìŠµë‹ˆë‹¤'}. í˜„ì¬: ${Math.round(actualProtein)}g â†’ ê¶Œì¥: ${recProtein}g (${Math.round(proteinRatio)}% ${proteinDiff > 0 ? 'ì´ˆê³¼' : 'ë¶€ì¡±'})`,
                    priority: 'medium'
                });
            } else {
                // 15% ì´ë‚´ = ì ì ˆ
                advices.push({
                    emoji: 'âœ¨',
                    text: `ë‹¨ë°±ì§ˆ ì„­ì·¨ê°€ ì ì ˆí•©ë‹ˆë‹¤. í˜„ì¬: ${Math.round(actualProtein)}g / ê¶Œì¥: ${recProtein}g`,
                    priority: 'low'
                });
            }

            // ì§€ë°© ì¡°ì–¸ (ê¸°ì¤€: Â±15%)
            const fatDiff = actualFat - recFat;
            const fatRatio = Math.abs(fatDiff) / recFat * 100;

            if (fatRatio > 20) {
                // 20% ì´ìƒ ë²—ì–´ë‚¨ = ê¸´ê¸‰
                advices.push({
                    emoji: 'ğŸ”',
                    text: `ì§€ë°© ì„­ì·¨ê°€ ${fatDiff > 0 ? 'ê³¼ë‹¤í•©ë‹ˆë‹¤' : 'ë¶€ì¡±í•©ë‹ˆë‹¤'}. í˜„ì¬: ${Math.round(actualFat)}g â†’ ê¶Œì¥: ${recFat}g (${Math.round(fatRatio)}% ${fatDiff > 0 ? 'ì´ˆê³¼' : 'ë¶€ì¡±'})`,
                    priority: 'high'
                });
            } else if (fatRatio > 15) {
                // 15~20% ë²”ìœ„ = ë³´í†µ
                advices.push({
                    emoji: 'ğŸ”',
                    text: `ì§€ë°© ì„­ì·¨ê°€ ${fatDiff > 0 ? 'ì•½ê°„ ë†’ìŠµë‹ˆë‹¤' : 'ì•½ê°„ ë‚®ìŠµë‹ˆë‹¤'}. í˜„ì¬: ${Math.round(actualFat)}g â†’ ê¶Œì¥: ${recFat}g (${Math.round(fatRatio)}% ${fatDiff > 0 ? 'ì´ˆê³¼' : 'ë¶€ì¡±'})`,
                    priority: 'medium'
                });
            } else {
                // 15% ì´ë‚´ = ì ì ˆ
                advices.push({
                    emoji: 'âš–ï¸',
                    text: `ì§€ë°© ì„­ì·¨ê°€ ì ì ˆí•©ë‹ˆë‹¤. í˜„ì¬: ${Math.round(actualFat)}g / ê¶Œì¥: ${recFat}g`,
                    priority: 'low'
                });
            }

            // HTML ìƒì„± ë° í‘œì‹œ
            advices.forEach(advice => {
                const adviceItem = document.createElement('div');
                adviceItem.className = 'advice-item';

                // ì´ëª¨ì§€
                const emojiSpan = document.createElement('span');
                emojiSpan.className = 'advice-emoji';
                emojiSpan.textContent = advice.emoji;

                // ì¡°ì–¸ í…ìŠ¤íŠ¸
                const textSpan = document.createElement('span');
                textSpan.className = 'advice-text';
                textSpan.textContent = advice.text;

                // ì¤„ë°”ê¿ˆ
                const brElement = document.createElement('br');

                // ìš°ì„ ìˆœìœ„ íƒœê·¸
                const prioritySpan = document.createElement('span');
                prioritySpan.className = 'advice-priority';
                prioritySpan.textContent = advice.priority === 'high' ? 'ê¸´ê¸‰' : advice.priority === 'medium' ? 'ë³´í†µ' : 'ë‚®ìŒ';

                if (advice.priority === 'high') {
                    prioritySpan.classList.add('priority-high');
                } else if (advice.priority === 'medium') {
                    prioritySpan.classList.add('priority-medium');
                } else {
                    prioritySpan.classList.add('priority-low');
                }

                adviceItem.appendChild(emojiSpan);
                adviceItem.appendChild(textSpan);
                adviceItem.appendChild(brElement);
                adviceItem.appendChild(prioritySpan);

                adviceList.appendChild(adviceItem);
            });

            document.getElementById('habitAdviceSection').style.display = 'block';
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹œ ì‹ìŠµê´€ ê°œì„  ì¡°ì–¸ë„ í•¨ê»˜ ë¡œë“œ
        async function loadReportData() {
            try {
                const token = localStorage.getItem('token');

                // ê¸°ê°„ ê³„ì‚°
                const today = new Date();
                let queryStartDate = new Date();
                let queryEndDate = new Date(today);

                if (currentPeriod === 'week') {
                    queryStartDate.setDate(queryEndDate.getDate() - 7);
                } else {
                    // ì›”ê°„: í˜„ì¬ ë‹¬ì˜ 1ì¼ë¶€í„° ì˜¤ëŠ˜ê¹Œì§€
                    queryStartDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    // queryEndDateëŠ” ì´ë¯¸ ì˜¤ëŠ˜ ë‚ ì§œ
                }

                const startDateStr = queryStartDate.toISOString().split('T')[0];
                const endDateStr = queryEndDate.toISOString().split('T')[0];

                console.log('ğŸ“… ì¡°íšŒ ê¸°ê°„:', startDateStr, '~', endDateStr, '| ëª¨ë“œ:', currentPeriod);

                // API í˜¸ì¶œ
                const response = await fetch(`/api/meal-records/period?userId=${userId}&startDate=${startDateStr}&endDate=${endDateStr}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }

                const mealRecords = await response.json();

                // ë°ì´í„° ë¶„ì„ ë° í‘œì‹œ
                analyzeMealRecords(mealRecords, queryStartDate, queryEndDate);
                displayMealRecords(mealRecords);
                displayWeeklyChart(mealRecords, queryStartDate, queryEndDate);

                // ì‹ìŠµê´€ ê°œì„  ì¡°ì–¸ ë¡œë“œ
                loadHabitAdvice();

            } catch (error) {
                console.error('ë ˆí¬íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
    </script>
</body>
</html>

